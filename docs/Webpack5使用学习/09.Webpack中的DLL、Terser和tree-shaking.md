---
title: Webpack中的DLL、Terser和tree-shaking
date: 2022-06-08 22:41:43
permalink: /pages/2734d2/
categories:
  - Webpack5使用学习
tags:
  - 
---
# Webpack中的DLL、Terser和tree-shaking

## DLL

### 认识DLL

DLL全称是动态链接库（Dynamic Link Library），是软件在Windows中实现共享函数库的一种实现方式；这是DLL名称的由来。

webpack中也有内置DLL的功能，可以实现JS代码的共享，将不经常改变的代码进行单独的编译，抽取成一个共享的库；

之后在项目编译时，就不需要再编译这部分公共共享代码。

如项目中用到了React、ReactDOM，那么就可以把它们编译成一个DLL库，之后只需要引用使用就可以，不需要每次都进行编译。

DLL库的使用分为两步:

1. 打包一个DLL库
2. 项目中引入DLL库

要注意的是，在升级到webpack4之后，React和Vue脚手架都移除了DLL库，Vue作者解释如下：

> https://github.com/vuejs/vue-cli/issues/1205
>
> `dll` option will be removed. Webpack 4 should provide good enough perf and the cost of maintaining DLL mode inside Vue CLI is no longer justified.

### 打包一个DLL库

在Webpack中可使用[DllPlugin](https://webpack.docschina.org/plugins/dll-plugin/#dllplugin)打包一个DLL库。

此插件用于在单独的 webpack 配置中创建一个 dll-only-bundle。 此插件会生成一个名为 `manifest.json` 的文件，这个文件中包含了从 require 和 import 中 request 到模块 id 的映射。

`manifest.json` 文件是用于让 [`DllReferencePlugin`](https://webpack.docschina.org/plugins/dll-plugin/#dllreferenceplugin) 能够映射到相应的依赖上。

此插件与 [`output.library`](https://webpack.docschina.org/configuration/output/#outputlibrary) 的选项相结合可以暴露出（也称为放入全局作用域）dll 函数。

这里我们使用React做相关测试，将`react`、`react-dom`打包到一个DLL库中。

配置如下：

```js {8,13,24-27}
const path = require('path')
const webpack = require('webpack')
const TerserPlguin = require('terser-webpack-plugin')
const { CleanWebpackPlugin } = require('clean-webpack-plugin')

module.exports = {
  entry: {
    react: ['react', 'react-dom']
  },
  output: {
    path: path.resolve(__dirname, './dll'),
    filename: 'dll_[name].js',
    library: 'dll_[name]'
  },
  optimization: {
    minimizer: [
      new TerserPlguin({
        extractComments: false
      })
    ]
  },
  plugins: [
    new CleanWebpackPlugin(),
    new webpack.DllPlugin({
      name: 'dll_[name]',
      path: path.resolve(__dirname, './dll/[name].manifest.json')
    })
  ]
}
```

*  entry中配置`react: ['react', 'react-dom']`，两个包为入口文件
* output中配置`library: 'dll_[name]'`，将入口文件导出的模块与`dll_[name]`进行绑定，打包库时，常用`library`配置，详见[output.library](https://webpack.docschina.org/configuration/output/#outputlibrary)
* 使用插件`new webpack.DllPlugin({...})`，options中设置了`name`和`path`
  * `name` 表示暴露出的 DLL 的函数名，这里是`dll_[name]`，与output.library保持相同，可以暴露出dll 函数，也就是将dll函数放入全局作用域。此处在全局作用域中可通过`dll_[name]`访问到暴露出来的模块。
  * `path`表示manifest.json 输出文件的 **绝对路径**

这里使用了`new CleanWebpackPlugin()`插件而不是使用`output.clean`，原因是测试中发现使用后者会出现没有生成`manifest.json`文件的情况。

执行`npm run build`可看到在dll目录中生成`dll.react.js`和`react.manifest.json`。

在`dll_react.js`中可看到我们配置的`output.library`和DllPlugin插件的`name`结合暴露在全局作用域中的变量：

```js
var dll_react;
(()=>{var e={448:(e,n,t)=>{"use strict";
  // ...
  dll_react = t;
})();                       
```

注意，此时，变量`dll_react`只与入口文件所导出的`react-dom`绑定。

### 使用一个DLL库

[DllReferencePlugin](https://webpack.docschina.org/plugins/dll-plugin/#dllreferenceplugin)插件可以通过`manifest.json`将DLL库映射到需要使用的项目中。

这里我们使用上面生成的React的DLL库。

如果使用了`react`和`react-dom`，使用了splitChunks的情况下，可以打包到一个独立的chunk中。

但是现在我们有了`dll_react.js`，不再需要单独去打包它们，可以直接去引用dll_react即可，需要两步：

1. 通过DllReferencePlugin插件告知要使用的DLL库；
2. 通过[AddAssetHtmlPlugin](https://github.com/SimenB/add-asset-html-webpack-plugin)插件，将打包的DLL库引入到打包的HTML模块中；

首先安装插件：

```shell
npm i add-asset-html-webpack-plugin -D
```

然后在Webpack中配置如下：

```js
const webpack = require('webpack');
const AddAssetHtmlPlugin = require("add-asset-html-webpack-plugin");

module.exports = {
  // ...
  plugins: [
    new webpack.DllReferencePlugin({
      context: path.resolve(__dirname, '../'), // manifest (或者是内容属性)中请求的上下文
      manifest: path.resolve(__dirname, "../dll/react.manifest.json")
    }),
    new AddAssetHtmlPlugin({
      filePath: path.resolve(__dirname, '../dll/dll_react.js'),
      outputPath: 'js',
      publicPath: 'js'
    })
  ],
  // ...
}
```

DllReferencePlugin插件会引用DLL库中的react、react-dom的代码

AddAssetHtmlPlugin插件会将`dll_react.js`移动到`build/js`目录，同时在打包的`index.html`中添添加一个script标签引入`dll_react.js`文件，如下：

```html {8}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Document</title>
    <script defer="defer" src="js/dll_react.js"></script>
    <script defer="defer" src="main.bundle.js"></script>
    <script defer="defer" src="index.bundle.js"></script>
    <link href="css/main.eb45b5.css" rel="stylesheet" />
  </head>
  <body>
    <div id="app"></div>
  </body>
</html>
```

AddAssetHtmlPlugin和[CopyWebpackPlugin](https://webpack.docschina.org/plugins/copy-webpack-plugin/)类似，都是将文件复制到构建目录中，不同的是，AddAssetHtmlPlugin除了将文件复制到build目录外，还会在HTML文件中添加引入的标签。
